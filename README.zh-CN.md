# Editable

一个实验性的富文本编辑器框架，希望通过自绘光标来替代原生 contenteditable 属性，提供更丰富、稳定的编辑能力。

## 开发

使用 `nextjs` & `turbo` 搭建的开发环境，使用 `typescript` 开发，单元测试使用的 jest。

```bash
# 安装
pnpm install

# 启动
pnpm dev

```

## 目录结构

所有源代码都在 packages 里面，apps 目录主要用作文档和测试用例，现在初始开发阶段里面写了一个React渲染编辑器模型、以及模型更新的逻辑，方便可视化测试。

本质上期望 `packages` 中全部使用 `js` 开发，与视图层分离，可以通过 `Dom`、`React`、`Vue` 实现不同的视图层来达到不仅限于某一个前端库使用的目地

### packages/constants

所有需要全局用到的常量都放在这里，统一管理

- `EVENT_` 开头为事件名称
- `DATA_` 开头为DOM节点所需要用到的数据名称定义
- `OP_` 为将来通过协同编辑器操作的一些操作名称定义

### packages/utils

工具包

- `ua` 提供终端类型判断，比如手机、安卓、iOS等
- `log` 提供日志输出，定义了一些常见的错误和异常，可以用来抛出异常

### packages/grapheme-breaker

主要对一些 `unicode` 字符进行索引的计算。因为有些字符占位所占的字节数不确定，造成某些字符拆分后的索引不准确，所以需要这个工具包来解决这个问题。

### packages/event-emitter

一个简单的事件处理器，稍微不同的是，绑定的事件在处理中返回 `false` 可以中断后续的事件触发。

### packages/model

数据模型，使用 `Map` 结构来存储数据，支持嵌套。

每个获取到的 `node` 对象都是副本，对他操作修改不会影响原始数据。

- `keys` 通过 generateRandomKey 方法可以生成一个唯一的 key
- `node` 节点，每个节点都有一个唯一的 key，可以通过 key 来获取节点。
- `text` 定义的文本节点，继承 node，他的 `type` 属性是固定的 `text`。提供了 `text` 和 `format` 来修改文本的内容和格式。
- `element` 非文本节点，继承 node，他的 `type` 由用户插件指定，可拥有无限的子节点
- `map` 存储的模型json数据，提供了两个 Map，一个Map记录所有的节点数据，另一个Map提供了父级与子级的对应关系
- `op` 提供了一些修改模型去生成操作命令的方法
- `index` 可以转换map数据为 node 对象。并且提供了一些操作map数据的方法。每次操作数据必会触发 `EVENT_NODE_UPDATE` 事件。

### packages/selection

光标与选区的选取、绘制、文本输入事件

- `layer` 渲染层，以 shadow 的方式渲染一些 box。主要用于光标、选区、文本输入框的位置渲染
- `input` 渲染一个 textarea 输入框在光标的位置提供输入拦截，有输入会触发文本变更事件，以及 focus 和 blur 事件
- `typing` 选区相关事件处理，以及通过坐标找到最近的节点来触发绘制光标、选区的事件
- `utils` 提供一些坐标与选区的计算和判断
- `range` 单个选区对象，模拟了一些与原生Range相同的方法
- `text` 提供了通过坐标查找最近文本索引的方法
- `index` 模拟原生 `selection` 的一些方法，以及绘制光标、选区的方法


### packages/core

主要整合 `model` 和 `selection` 提供操作方法、事件处理等。

- `typing` 封装了一些常用事件钩子
- `index` 插件注册。处理模型变更 -> 视图渲染 -> 光标选区渲染的逻辑


### apps/docs

- `components` 定义了三个不同类型节点的渲染视图、以及注册插件的方法。Text 中还处理了针对组合输入法的渲染逻辑
- `hooks` 封装编辑器模型变更 -> 视图渲染 -> 光标选区渲染的逻辑处理

## 任务

### Selection

- [x] 英文键盘输入
- [x] 组合输入法输入
- [x] 光标选区渲染
- [x] 文本输入框渲染
- [x] 拖拽鼠标选择选区与光标
- [x] 获取选中的全部内容 api
- [ ] 键盘上下左右切换光标和选区
- [ ] 鼠标双击、三击选中文本
- [ ] 触摸选择选区与光标
- [ ] 单元测试全覆盖

### Model

- [x] 插入文本
- [x] 删除文本
- [ ] 修改文本格式
- [x] 插入节点
- [x] 删除节点
- [ ] 修改节点样式
- [ ] 修改节点DATA
- [ ] Grid 节点类型设计

### Core

- [x] 插件注册
- [x] 渲染插件
- [ ] 插件钩子
- [ ] 非渲染型的插件处理
- [ ] 设计 block 和 inline 类型的定义与处理
- [x] 在光标处插入文本
- [x] 在光标处插入节点
- [x] 删除当前选区内容
- [x] 通过按键 backspace & delete 删除光标位置前后文本
- [ ] 回车处理

### View

- [ ] DOM 视图渲染设计
- [ ] React 视图渲染设计（部分）
- [ ] Vue 视图渲染设计
